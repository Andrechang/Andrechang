<h1 id="intro">0. Intro</h1>
<p>To start working on the Zedboard and deploying the FPGA design that you made.</p>

<h1 id="prepare-u-boot-linux-kernel-and-device-tree">1. Prepare U-Boot, Linux Kernel and Device tree.</h1>
<p>In the boot partition of the SDcard, we need three files:</p>

<ul>
  <li>uImage  - done in the build kernel section (linux-xlnx/arch/arm/boot/uImage)</li>
  <li>devicetree.dtb  - done in the build devicetree section (linux-xlnx/arch/arm/boot/dts/zynq-zed.dts)</li>
  <li>boot.bin  - follow the sections below</li>
</ul>

<p>More information http://www.wiki.xilinx.com/Getting+Started</p>

<h2 id="fetch-sources">Fetch Sources</h2>

<p>There are two repos that will need to be cloned, one for u-boot and the other
for the linux kernel. Both repos are maintained by Xilinx.</p>

<p>Make sure to clone the folders u-boot-xlnx and linux-xlnx in the same directory of zynq-axis.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/Xilinx/u-boot-xlnx
git clone https://github.com/Xilinx/linux-xlnx
</code></pre>
</div>

<h2 id="setup-environmental-variables">Setup Environmental Variables</h2>

<p>Both the u-boot and the kernel will need to be built using the cross compile
tools. These tools should have been installed as part of the Xilinx ISE
package.</p>

<p>For vivado these tools where installed with SDK. Make sure to have SDK installed.</p>

<h3 id="tool-location-variable">Tool Location Variable</h3>

<p>On the elab server it is:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">export </span><span class="nv">XILINX_EDK</span><span class="o">=</span>/export/home/a/workspace/Xilinx/14.4/ISE_DS/EDK
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$XILINX_EDK</span>/gnu/arm/lin/bin:<span class="nv">$PATH</span>
</code></pre>
</div>

<p>On a default linux install:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">export </span><span class="nv">XILINX_EDK</span><span class="o">=</span>/opt/Xilinx/14.4/ISE_DS/EDK
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$XILINX_EDK</span>/gnu/arm/lin/bin:<span class="nv">$PATH</span>
</code></pre>
</div>

<p>Or for Vivado</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">export </span><span class="nv">XILINX_SDK</span><span class="o">=</span>/opt/Xilinx/SDK/2014.2
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$XILINX_SDK</span>/gnu/arm/lin/bin:<span class="nv">$PATH</span>
</code></pre>
</div>

<h3 id="cross-compile-variables">Cross Compile Variables</h3>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">export </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-xilinx-linux-gnueabi-
</code></pre>
</div>

<h3 id="kernel-build-variables">Kernel Build Variables</h3>

<p>Only needed to build the kernel.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">export </span><span class="nv">ARCH</span><span class="o">=</span>arm
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PWD</span>/u-boot-xlnx/tools:<span class="nv">$PATH</span>
</code></pre>
</div>

<h2 id="dependencies">Dependencies</h2>
<p>There may be some dependencies and packages that need to be installed before building the u-boot:</p>

<p>(http://forums.xilinx.com/t5/Embedded-Linux/Xilinx-Zynq-7000-ZC702-Linux-build-issue/m-p/426328#M8213)</p>

<ul>
  <li>gawk</li>
  <li>build-essential</li>
  <li>utomake</li>
  <li>libtool</li>
  <li>lib32ncurses5</li>
  <li>lib32ncurses5-dev</li>
  <li>lib32ncursesw5</li>
  <li>ncurses-dev:i386</li>
  <li>libstdc++6:i386</li>
  <li>libselinux1:i386</li>
  <li>libgmpxx4ldbl</li>
  <li>libppl13</li>
  <li>libppl-c4</li>
  <li>libcloog-ppl1</li>
</ul>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo apt-get install ia32-libs
sudo apt-get install u-boot-tools lzop
sudo apt-get install libssl-dev
</code></pre>
</div>

<h2 id="build-u-boot">Build u-boot</h2>

<p>The linux system boots using u-boot from an SD Card root file system.</p>

<p>Then go to the u-boot-xlnx folder
<code class="highlighter-rouge">bash
cd u-boot-xlnx
</code></p>

<h3 id="patch-boot-options">Patch boot options</h3>

<p>We don’t want a ramdisk rootfs because the system (OS kernel and applications) is copied from SDcard to a RAM memory during boot. 
And all the work done on the system is saved on a RAM, which means that it will disappear once we turn off the zedboard. 
To avoid this, we want to boot and run the system on SDcard so that we can save our modifications.</p>

<p>The Xilinx standard u-boot master assumes a ramdisk rootfs. This patch will
ensure the SD card boots from the rootfs on the SD card.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'
diff --git a/include/configs/zynq_common.h b/include/configs/zynq-common.h
--- a/include/configs/zynq-common.h
+++ b/include/configs/zynq-common.h
@@ -241,7 +241,7 @@
        "sdboot=if mmcinfo; then " \
			"run uenvboot; " \
			"echo Copying Linux from SD to RAM... &amp;&amp; " \
			"load mmc 0 ${kernel_load_address} ${kernel_image} &amp;&amp; " \
			"load mmc 0 ${devicetree_load_address} ${devicetree_image} &amp;&amp; " \
-			"load mmc 0 ${ramdisk_load_address} ${ramdisk_image} &amp;&amp; " \
-			"bootm ${kernel_load_address} ${ramdisk_load_address} ${devicetree_load_address}; " \
+			"bootm ${kernel_load_address} - ${devicetree_load_address}; " \
		"fi\0" \
	"usbboot=if usb start; then " \
			"run uenvboot; " \
			"echo Copying Linux from USB to RAM... &amp;&amp; " \
			"load usb 0 ${kernel_load_address} ${kernel_image} &amp;&amp; " \
'</span> | git apply -
</code></pre>
</div>

<p>Get rid of the line that has -</p>

<p>and add the line that has +</p>

<h3 id="building-u-boot-tools">Building u-boot tools</h3>
<p>http://www.wiki.xilinx.com/Build+U-Boot</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>make zynq_zc706_config
</code></pre>
</div>
<p>or
<code class="highlighter-rouge">bash
make zynq_zed_config
make
</code></p>

<p>Only needed to build the kernel.
After building the u-boot, the target u-boot elf-file is created in the top level source directory, named ‘u-boot’. 
Additionally in the tools/ directory the ‘mkimage’ utility is created, which is used in other tasks to wrap images into u-boot format.
To make mkimage available in other steps, it is recommended to add the tools directory to your $PATH.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">export </span><span class="nv">ARCH</span><span class="o">=</span>arm
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PWD</span>/u-boot-xlnx/tools:<span class="nv">$PATH</span>
</code></pre>
</div>

<h2 id="build-linux-kernel">Build Linux Kernel</h2>

<p>See http://www.wiki.xilinx.com/Build+kernel</p>

<p>add a line to /arch/arm/configs/xilinx_zynq_defconfig:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nv">CONFIG_DMA_CMA</span><span class="o">=</span>y
</code></pre>
</div>
<p>Then build kernel with:
<code class="highlighter-rouge">bash
make ARCH=arm xilinx_zynq_defconfig
make ARCH=arm menuconfig
make ARCH=arm UIMAGE_LOADADDR=0x8000 uImage
</code></p>

<p>In the process, linux-xlnx/arch/arm/boot/Image and linux-xlnx/arch/arm/boot/zImage are created.
The Image file is the uncompressed kernel image and the zImage file is a compressed kernel image which will uncompress itself when it starts.</p>

<p>If the mkimage utility is available in the build environment, linux-xlnx/arch/arm/boot/uImage will be created by wrapping zImage with a U-Boot header.</p>

<h3 id="compiler-version-troubleshooting">Compiler version Troubleshooting</h3>
<p>The gcc compiler versions below are not supported:
 * GCC 3.0, 3.1: general bad code generation.
 * GCC 3.2.0: incorrect function argument offset calculation.
 * GCC 3.2.x: miscompiles NEW_AUX_ENT in fs/binfmt_elf.c (http://gcc.gnu.org/PR8896) and incorrect structure initialisation in fs/jffs2/erase.c</p>

<ul>
  <li>GCC 4.8.0-4.8.2: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=58854 miscompiles find_get_entry(), and can result in EXT3 and EXT4 filesystem corruption (possibly other FS too).</li>
</ul>

<p>Make sure the gcc compiler version is not 4.8.1 or 4.8.2</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>gcc -v
</code></pre>
</div>

<p>If it is then try to change the default gcc to a lower version, by switching the gcc link “/usr/bin/gcc”:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>apt-get install gcc-4.7
sudo rm /usr/bin/gcc
sudo ln -s /usr/bin/gcc-4.7 /usr/bin/gcc
</code></pre>
</div>

<p>Make sure the arm-xilinx-linux-gnueabi-gcc version is not 4.8.1 or 4.8.2</p>

<p>asm-offses.c will output an error (buggy compiler) if arm-xilinx-linux-gnueabi-gcc version is 4.8.1 or 4.8.2</p>

<p>Check with:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>arm-xilinx-linux-gnueabi-gcc -v
</code></pre>
</div>

<h2 id="build-device-tree">Build Device Tree</h2>

<p>Patch the default zedboard device tree source file mount the root file system
from the second partition of the SD card instead of ram.</p>

<p>Change the file linux-xlnx/arch/arm/boot/dts/zynq-zed.dts</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'
diff --git a/arch/arm/boot/dts/zynq-zed.dts b/arch/arm/boot/dts/zynq-zed.dts
--- a/arch/arm/boot/dts/zynq-zed.dts
+++ b/arch/arm/boot/dts/zynq-zed.dts
@@ -40,7 +40,7 @@
 	memory {
		device_type = "memory";
		reg = &lt;0x0 0x20000000&gt;;
	};
 	chosen {
-		bootargs = "console=ttyPS0,115200 root=/dev/ram rw earlyprintk";
+		bootargs = "cma=64M console=ttyPS0,115200 root=/dev/mmcblk0p2 rw earlyprintk rootfstype=ext4 rootwait devtmpfs.mount=0";
 		linux,stdout-path = "/axi@0/serial@e0001000";
 	} ;
    };

    &amp;qspi {

'</span> | git apply -
</code></pre>
</div>

<p>Then build the device tree blob.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>make zynq-zed.dtb
</code></pre>
</div>

<h3 id="modifying-devicetree-for-axis">Modifying Devicetree for AXIS</h3>

<p>The following AXIS device node needs to be added to the Zynq devicetree to expose the new hardware to the AXIS driver.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>axis: axis@43C00000 <span class="o">{</span>
    compatible <span class="o">=</span> <span class="s2">"xlnx,axis-1.00"</span>;
    reg <span class="o">=</span> &lt; 0x43C00000 0x10000 &gt;;
    xlnx,num-mem <span class="o">=</span> &lt;0x1&gt;;
    xlnx,num-reg <span class="o">=</span> &lt;0x20&gt;;
    xlnx,s-axi-min-size <span class="o">=</span> &lt;0x1ff&gt;;
    xlnx,slv-awidth <span class="o">=</span> &lt;0x20&gt;;
    xlnx,slv-dwidth <span class="o">=</span> &lt;0x20&gt;;
<span class="o">}</span>;
</code></pre>
</div>
<p>Source code for a usable and tested devicetree has been placed in the zynq-axis/util directory. 
It is an altered version of the ‘arch/arm/boot/dts/zynq-7000.dtsi’ file found in the linux-xlnx Xilinx repo, 
master branch commit (da2d296bb6b89f7bc7644f6b552b9766ac1c17d5).</p>

<p>Once the kernel has been compiled for the Zynq, place the altered ‘zynq-7000-dtsi’ file into the kernel ‘arch/arm/boot/dts’ directory. 
Then compile the new devicetree, for the Zedboard run the following command.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>make zynq-zed.dtb
</code></pre>
</div>

<h1 id="making-a-bootable-sdcard-with-linaro-linux-for-zynq">3. Making a Bootable SDcard with Linaro Linux for Zynq</h1>

<p>We need two partitions on the SDcard: one for boot and one for the Linaro Linux system</p>

<p>In the boot partition of the SDcard, we need three files:</p>

<ul>
  <li>uImage  - done in the build kernel section (linux-xlnx/arch/arm/boot/uImage)</li>
  <li>devicetree.dtb  - done in the build devicetree section (linux-xlnx/arch/arm/boot/dts/zynq-zed.dts)</li>
  <li>boot.bin  - follow the sections below</li>
</ul>

<p>Instructions to setup our custom, headless Linaro system for the Zedboard/Zynq.
Very good source <a href="http://fpgacpu.wordpress.com/2013/05/24/yet-another-guide-to-running-linaro-ubuntu-desktop-on-xilinx-zynq-on-the-zedboard">guide</a>.</p>

<h2 id="partition-sd-card">Partition SD Card:</h2>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo apt-get install gparted
sudo gparted
</code></pre>
</div>

<p>2 partitions, 1st is 40 MB, fat32 and Labeled “BOOT”. 2nd partition is 2048 MB,
ext4 and Labeled “rootfs”.</p>

<p>Once you partitioned the SDcard, check if there are two partitions to be mounted:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo fdisk -l
</code></pre>
</div>
<p>You should see something with “/dev/sdb1” and “/dev/sdb2” in the output</p>

<p>Mount both partitions:
<code class="highlighter-rouge">bash
sudo  mkdir /media/BOOT
sudo  mkdir /media/rootfs
sudo mount /dev/sdb1 /media/BOOT
sudo mount /dev/sdb2 /media/rootfs
</code></p>

<p>Once you are done making the SDcard, dont forget to un-mount it
<code class="highlighter-rouge">bash
sudo umount /media/sdb1
sudo umount /media/sdb2
</code></p>

<h2 id="download-linaro-rootfs">Download linaro rootfs:</h2>

<p>http://www.linaro.org/downloads/</p>

<p>Scroll to the “Developers and Community Builds” section. In the table entry for
“Ubuntu Desktop” click one of the links in the “download” section.</p>

<p>As of writing this was the latest “desktop” release URL is.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>wget https://releases.linaro.org/archive/12.11/ubuntu/precise-images/ubuntu-desktop/linaro-precise-ubuntu-desktop-20121124-560.tar.gz
</code></pre>
</div>

<h2 id="copy-files-to-sd-card">Copy files to SD Card</h2>

<p>After downloading the Linaro, you need to extract the tar.gz into the rootfs partition in the SDcard.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo tar --strip-components<span class="o">=</span>3 -C /media/rootfs -xzpf linaro-precise-ubuntu-desktop-20121124-560.tar.gz binary/boot/filesystem.dir
</code></pre>
</div>

<p>After following the section “2. Prepare U-Boot, Linux Kernel and Device tree”, 
you can copy uImage and devicetree file to BOOT partition of the SDcard</p>

<p>copy uImage from linux-xlnx/arch/arm/boot/uImage to /media/BOOT/</p>

<p>copy zynq-zed.dtb file from linux-xlnx/arch/arm/boot/dts/ to /media/BOOT/ and rename as “devicetree.dtb”</p>

<h2 id="build-fsbl-first-stage-boot-loader">Build FSBL (First stage boot loader)</h2>

<p>Look into xilinx document chapter 5 http://forums.xilinx.com/xlnx/attachments/xlnx/ELINUX/8467/1/zedboard_CTT_v2013_2_130807.pdf</p>

<p>In order to relate the software (Linux) with the hardware PL (programable logic) that you created,
we need to create a FSBL(first state boot loader) application in Xilinx SDK program. 
Thus, we need the hardware from  section “1. Hardware”. 
Remember that the Vivado project is in /zynq-axis-master/syn/scratch/project-zedboard_axis/
But, the generated bitstream file is in /zynq-axis-master/zedboard_axis.bit</p>

<p>In the Vivado program, after the Bitstream generation completes, 
you need to export the hardware File &gt; Export &gt; Export Hardware
(make sure that you enable the “Include Bitstream” option).</p>

<p>Then launch SDK.</p>

<p>In SDK, select File &gt; New &gt; Application Project.
The New Project wizard opens; for Project Name, type in zynq_fsbl_0 and
click Next.</p>

<p>Select Zynq FSBL in the Template list and keep the remaining default options.
The Location of your project, the hardware platform used, and the processor are
visible in this window.</p>

<p>Click Finish to generate the FSBL.</p>

<p>The Zynq FSBL compiles and .ELF file is generated in the folder</p>

<p>your_project_path / project_name.sdk / zynq_fsbl_0 / Debug /</p>

<h2 id="generate-bootbin-file">Generate BOOT.BIN file</h2>

<p>To generate the last file need for the SDcard, we need to get copy of:</p>

<ul>
  <li>system.bit (zedboard_axis.bit - bitfile generated in Vivado),</li>
  <li>u-boot.elf (in u-boot-xlnx folder. Need to rename u-boot to u-boot.elf) and</li>
  <li>zynq_fsbl.elf (created using Xilinx SDK).</li>
</ul>

<p>Then create a .bif file.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> -n <span class="s1">'the_ROM_image:
{
[bootloader]zynq_fsbl.elf
zedboard_axis.bit
u-boot.elf
}
'</span> &gt; bootconfig.bif

bootgen -image bootconfig.bif -o i boot.bin
</code></pre>
</div>

<p>You can also use the SDK to generate the boot.bin. Refer to xilinx tutorial.</p>

<p>Don’t forget to copy the boot.bin to /media/BOOT/</p>

<h2 id="bootup">Bootup</h2>

<p>The above instructions should make a bootable SD Card. Make sure the jumpers
are set correctly on the Zedboard, insert SD Card and power up.</p>

<p>Jumpers: JP7-GND, JP8-GND, JP9-3V, JP10-3V, JP11-GND</p>

<p>Connect a USB to the UART port and start up a Serial Terminal (eg. gtkterm) to
view boot messages and get first access to the system.</p>

<h1 id="linux-uio-driver">4. Linux UIO Driver</h1>

<p>This Linux driver has been developed to run on the Xilinx Zynq ARM. It is a userspace input/output driver (UIO) that enables the passing of register values to and from the Zynq FPGA. Userspace libraries/applications use this UIO driver to configure and control the AXIS modules operation. It also controls a contiguous memory area that is used to pass data between the host (PS) and FPGA (PL) sides of the Zynq.</p>

<h2 id="compile-driver">Compile Driver</h2>

<p>Kernel modules need to be built against the version of the kernel it will be inserted in. It is recommended to uses the Linux kernel maintained by Xilinx.
https://github.com/Xilinx/linux-xlnx.git</p>

<p>The driver module can be compiling outside of the Linux kernel source tree. 
A variable ‘KDIR’ in the Makefile is used to point to the kernel source directory. 
The default value has it pointing to the default Linux install location for kernel sources. 
However, if cross compiling or if the sources are in a non-default location the value can be overridden using 
an exported environmental variable or as an argument passes into the make command.
Assuming that folder linux-xlnx and zynq-axis are in the same directory.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">cd </span>zynq-axis/dev/
<span class="nb">export </span><span class="nv">KDIR</span><span class="o">=</span>../../linux-xlnx
make
</code></pre>
</div>

<p>or</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">cd </span>zynq-axis/dev/
make <span class="nv">KDIR</span><span class="o">=</span>../../linux-xlnx
</code></pre>
</div>
<p>After compiling the driver, you need to have the zynq-axis files on the zedboard (embedded linux).</p>

<p>One way to do this is to copy the folder zynq-axis to the rootfs partition of the SDcard.</p>

<p>The following sections are done in the embedded linux through a serial connection (eg. gtkterm or putty).</p>

<h2 id="installing-driver">Installing Driver</h2>

<p>Use of the driver module requires it to be inserted into the running Linux kernel. Once inserted it will automatically create a character device file in ‘/dev’ called ‘/dev/uio*’. However, the default permissions will not allow non-root users to read/write to the file, nor is the numbering consistent if more then one UIO driver is being used. These problems are overcome by installing the udev rule file found in this projects util directory into the systems ‘/etc/udev/rules.d/’ directory.
<code class="highlighter-rouge">bash
sudo cp util/80-axis.rules /etc/udev/rules.d/
</code></p>

<p>To install the module and have it loaded at boot, first install the udev rule as shown above and then follow the below instructions.
<code class="highlighter-rouge">bash
sudo mkdir -p /lib/modules/$(uname -r)/extra/
sudo cp axis.ko /lib/modules/$(uname -r)/extra/
sudo depmod -a
</code>
Need reboot here.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo reboot
sudo modprobe axis
</code></pre>
</div>

<p>If there is error saying that Kernel dont have support axis.ko after sudo modprobe axis</p>

<p>Then your Kernel or your driver was build wrong. Redo section “2.Build Linux Kernel” and load the newest uImage into SDcard.
Also do section “4. Compile Driver” again and load the newest zynq-axis/dev folder into SDcard</p>

<h2 id="library">Library</h2>

<p>The axis library has to be built and installed on the Zynq before the example applications can be compiled. The library offers a number of generic functions for use in configuring the axis hardware.
<code class="highlighter-rouge">bash
cd zynq-axis/lib/
make
make install
</code></p>

<h2 id="applications">Applications</h2>

<p>The example application demonstrates some simple usage of the AXIS system.
<code class="highlighter-rouge">bash
cd zynq-axis/app/
make
</code>
Try it out:
<code class="highlighter-rouge">bash
cd zynq-axis/app/
./test-mem /dev/axis
</code></p>

<h1 id="customize-linaro-system">5.Customize Linaro System</h1>

<p>The following have been done to make the <em>elab</em> system.</p>

<h2 id="turn-off-swapping">Turn off swapping:</h2>

<p>This reduces the amount of data being written to the SD card and thus make it
less likely to throw an error during heavy use. Since the linaro system is not
being used for any RAM heavy task this is unlikely to cause problems. It also
reduces the likelihood of the system crashing during the running of our demos.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"vm.swappiness = 0"</span> | sudo tee -a /etc/sysctl.conf
sudo reboot
</code></pre>
</div>

<p>You cat find out what the systems ‘swapiness’ is set to using:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>cat /proc/sys/vm/swappiness
</code></pre>
</div>

<h2 id="turn-off-logging">Turn off logging:</h2>

<p>Logging on our system can quickly use up all available space on the SD card by
writing to the “/var/log/kern.log” file and “/var/log/syslog” file. The easiest
way to stop that is to turn off system logging:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">echo </span>manual | sudo tee --append /etc/init/rsyslog.override
</code></pre>
</div>
<p>source (http://askubuntu.com/questions/306237/how-to-disable-the-log-files)</p>

<h2 id="use-tmpfs-for-some-system-directories">Use tmpfs for some system directories</h2>

<p>When the system writes to any of these system directories they will write to a
ram disk instead of the SD card. This reduces the number and frequency of
writes to the SD card and thus makes the system ans a whole more stable.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> -n <span class="s1">'
tmpfs        /var/run       tmpfs    defaults,noatime    0    0
tmpfs        /var/lock      tmpfs    defaults,noatime    0    0
tmpfs        /var/log       tmpfs    defaults,noatime    0    0
tmpfs        /var/run       tmpfs    defaults,noatime    0    0
tmpfs        /var/mail      tmpfs    defaults,noatime    0    0
tmpfs        /var/spool     tmpfs    defaults,noatime    0    0
tmpfs        /var/tmp       tmpfs    defaults,noatime    0    0
tmpfs        /var/cache     tmpfs    defaults,noatime    0    0
'</span> | sudo tee -a /etc/fstab

</code></pre>
</div>

<h2 id="ssh-server">SSH Server:</h2>

<p>Dropbear</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>apt-get install -y dropbear
</code></pre>
</div>

<p>make it so root cannot ssh in.</p>

<p>vim /etc/default/dropbear
DROPBEAR_EXTRA_ARGS=”-w”</p>

<h2 id="time-on-the-zedboard">Time on the Zedboard</h2>

<p>The Zedboard will forget the time on a power cycle, to work around this have
the Zedboard get the time from the network.</p>

<h3 id="setting-clock-with-ntp-network-time-protocol">Setting Clock with NTP (network time protocol):</h3>

<p>sudo apt-get install -y ntp</p>

<p>sudo ntpdate horologe.cerias.purdue.edu</p>

<p>(http://askubuntu.com/questions/244526/unable-to-synchronize-time-using-ntp)</p>

<p>sudo vim /etc/ntp.conf # add line: “server horologe.cerias.purdue.edu” to file</p>

<h3 id="time-zone">Time Zone:</h3>

<p>sudo dpkg-reconfigure tzdata</p>

<p>(http://www.wikihow.com/Change-the-Timezone-in-Linux)</p>

<h2 id="ip-monitor-script">IP Monitor Script</h2>

<p>A small script will be setup to run at boot that will monitor when a new dhcp
lease has been acquired. A new dhcp lease is always acquired when a new IP
address is assigned to the Zedboard by a dhcp server.</p>

<p>First, a non-pass-phrase protected ssh key pair needs to be generated so that
the monitor script can communicate with the elab server without requiring a
password. This can be done on a computer that has OpenSSH installed and then by
copying the two key files over to the Zedboard. Once the keys are on the
Zedboard, rename the two key files “rsync_id_rsa” and “rsync_id_rsa.pub”, then
move them to a directory called “$HOME/.ip_addr/”.</p>

<p>On the server:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>ssh-keygen -t rsa -f rsync_id_rsa
</code></pre>
</div>

<p>On the zynq:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>mkdir -p <span class="nv">$HOME</span>/.ip_addr
cp rsync_id_rsa<span class="k">*</span> <span class="nv">$HOME</span>/.ip_addr/
chmod 400 <span class="nv">$HOME</span>/.ip_addr/rsync_id_rsa<span class="k">*</span>
</code></pre>
</div>

<p>To enable auto log-in from Zedboard to server, the contents of
“rsync_id_rsa.pub” needs to be added to the “.ssh/authorized_keys” file on the
elab server. For safety it is best to restrict the actions of the ssh key to
just rsync of a single directory. Thus when adding the ssh pub key to the elabs
“.ssh/authorized_keys” file, include the following ‘command’ to the entry:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>command="rsync --server -vvvlogDtpre.iLsf . ${HOME}/.ip_addr/" ssh-rsa &lt;zedboard ssh-rsa pub key&gt; linaro@zynq
</code></pre>
</div>

<p>Remember to replace <zedboard ssh-rsa="" pub="" key=""> with __your__ ssh-rsa public key
from the Zedboard. Then create the monitor program on the Zedboard:</zedboard></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>apt-get install -y inotify-tools
mkdir <span class="nv">$HOME</span>/.ip_addr
<span class="nb">echo</span> -n <span class="s1">'
sleep 2
hostname -I &gt; /home/linaro/.ip_addr/ip-addr-$(hostname)

if [ -n "$(cat /home/linaro/.ip_addr/ip-addr-$(hostname) | tr -d " ")" ]
then
	rsync -a -e "ssh -i ${HOME}/.ip_addr/rsync_id_rsa" ${HOME}/.ip_addr/ip-addr-$(hostname) &lt;username&gt;@elab.ecn.purdue.edu:${HOME}/.ip_addr
else
	sleep 60
	hostname -I &gt; /home/linaro/.ip_addr/ip-addr-$(hostname)

	if [ -z "$(cat /home/linaro/.ip_addr/ip-addr-$(hostname) | tr -d " ")" ]
	then
		echo "reboot"
		sudo reboot
	fi
fi


while inotifywait -e modify -e create -e delete -e move -r $1; do
	sleep 2
	hostname -I &gt; /home/linaro/.ip_addr/ip-addr-$(hostname)

	if [ -n "$(cat /home/linaro/.ip_addr/ip-addr-$(hostname) | tr -d " ")" ]
	then
		rsync -a -e "ssh -i ${HOME}/.ip_addr/rsync_id_rsa" ${HOME}/.ip_addr/ip-addr-$(hostname) &lt;username&gt;@elab.ecn.purdue.edu:${HOME}/.ip_addr
	else
		sleep 60
		hostname -I &gt; /home/linaro/.ip_addr/ip-addr-$(hostname)

		if [ -z "$(cat /home/linaro/.ip_addr/ip-addr-$(hostname) | tr -d " ")" ]
		then
			echo "reboot"
			sudo reboot
		fi
	fi
done
'</span> &gt; <span class="nv">$HOME</span>/.ip_addr/ip-monitor
chmod 744 <span class="nv">$HOME</span>/.ip_addr/ip-monitor
</code></pre>
</div>

<p>Edit /etc/rc.local script and add the following before ‘exit 0’:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>su -l linaro -c <span class="s1">'/home/linaro/.ip_addr/ip-monitor /var/lib/dhcp &amp;&gt; /dev/null &amp;'</span>
</code></pre>
</div>

<p>On elab server add to your “$HOME/.bashrc” file:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="k">function </span>linaro<span class="o">()</span> <span class="o">{</span>
	<span class="k">while</span> <span class="o">[</span> 1 <span class="o">]</span>
	<span class="k">do
		case</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="k">in
			</span>p<span class="p">)</span> cat <span class="nv">$HOME</span>/.ip_addr/ip-addr-&lt;zync hostname&gt; | tr -d <span class="s1">' '</span>; <span class="nb">break</span><span class="p">;;</span>
			b<span class="p">)</span> ssh -o <span class="nv">ConnectTimeout</span><span class="o">=</span>1 -i ~/.ssh/id_rsa_zynq linaro@<span class="k">$(</span>cat <span class="nv">$HOME</span>/.ip_addr/ip-addr-&lt;zync hostname&gt; | tr -d <span class="s1">' '</span><span class="k">)</span>; <span class="nb">break</span><span class="p">;;</span>
			<span class="k">*</span><span class="p">)</span> ssh -X -t -q -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no -o <span class="nv">ConnectTimeout</span><span class="o">=</span>1 -i ~/.ssh/id_rsa_zynq linaro@<span class="k">$(</span>cat <span class="nv">$HOME</span>/.ip_addr/ip-addr-&lt;zynq hostname&gt; | tr -d <span class="s1">' '</span><span class="k">)</span> <span class="s2">"tmux attach -d || tmux new"</span>; sleep 3;;
		<span class="k">esac
	done</span>
<span class="o">}</span>
</code></pre>
</div>

<p>If the Zedboard changes IP addresses while you are logged in, the ssh session
will freeze. The ‘ConnectTimeout’ in the above commands will automatically end
the session after a second. Alternatively, you can add the following line to the
“.ssh/config” file on the elab server.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ServerAliveInterval 1
</code></pre>
</div>

<p>The above ‘linaro’ function works best when you have auto login using ssh keys.
If however your default ssh key is password protected you might fine it best to
generate second key for use just with the Zedboard. To use the 2nd key add the
‘-i’ flag to the ssh commands in the ‘linaro’ function, example below.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>-i ~/.ssh/id_rsa_zynq
</code></pre>
</div>

<h2 id="rename-system">Rename System</h2>

<p>Edit /etc/hostname to be the new hostname</p>

<p>and edit last line in /etc/hosts</p>

<p>127.0.1.1       <new hostname=""></new></p>

<h2 id="mount-sd-card-partitions">Mount SD Card Partitions</h2>

<p>Add:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>devtmpfs.mount=1
</code></pre>
</div>

<p>to the bootargs in the devicetree. This will get the mmcblk0 device to show up.</p>

<p>To make it easy to mount a partition (for example the “boot” partition) by a
user (without using sudo), add the following to the “/etc/fstab” file.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/dev/mmcblk0p1  /boot   vfat    defaults,noauto,users   0       0
</code></pre>
</div>

<h2 id="workaround-for-cpufreq-error">Workaround for cpufreq error</h2>

<p>Since the zynq is having problems with changing the scaling of the clock
frequency the Linaro system must limit the number of frequencies it can use.
The following workaround should be applied when the error “cpufreq_cpu0: failed to
set clock rate: -16” shows up in the UART or/and when the reported system clock
is slower then the wall clock time.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo update-rc.d ondemand disable
</code></pre>
</div>
<p>The above was taken from the following Xilinx forum discussion.</p>

<p>http://forums.xilinx.com/t5/Embedded-Linux/System-clock-is-slow/m-p/411993/highlight/true#M7830</p>

<h2 id="linux-setup">Linux setup</h2>
<p>sudo apt-get install openssh-client openssh-server</p>

<p>passwd</p>
